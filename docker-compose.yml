services:
  auth-db:
    image: postgres:16
    environment:
      POSTGRES_DB: auth
      POSTGRES_USER: auth
      POSTGRES_PASSWORD: auth
    ports: ["5433:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth -d auth"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - auth_data:/var/lib/postgresql/data

  forms-db:
    image: postgres:16
    environment:
      POSTGRES_DB: forms
      POSTGRES_USER: forms
      POSTGRES_PASSWORD: forms
    ports: ["5434:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U forms -d forms"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - forms_data:/var/lib/postgresql/data

  responses-db:
    image: postgres:16
    environment:
      POSTGRES_DB: resp
      POSTGRES_USER: resp
      POSTGRES_PASSWORD: resp
    ports: ["5435:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U resp -d resp"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - resp_data:/var/lib/postgresql/data

  auth-service:
    build: ./services/auth-service
    env_file: .env
    environment:
      DATABASE_URL: ${AUTH_DB}
      CORS_ORIGINS: ${CORS_ORIGINS}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      auth-db:
        condition: service_healthy
    ports: ["8001:8000"]

  forms-service:
    build: ./services/forms-service
    env_file: .env
    environment:
      DATABASE_URL: ${FORMS_DB}
      CORS_ORIGINS: ${CORS_ORIGINS}
      JWT_SECRET: ${JWT_SECRET}
      AUTH_API: ${VITE_AUTH_API:-http://auth-service:8000}
    depends_on:
      forms-db:
        condition: service_healthy
      auth-service:
        condition: service_started
    ports: ["8002:8000"]

  responses-service:
    build: ./services/responses-service
    env_file: .env
    environment:
      DATABASE_URL: ${RESP_DB}
      CORS_ORIGINS: ${CORS_ORIGINS}
      FORMS_API: ${FORMS_API:-http://forms-service:8000}
    depends_on:
      responses-db:
        condition: service_healthy
      forms-service:
        condition: service_started
    ports: ["8003:8000"]

  web-frontend:
    build:
      context: ./frontend
    env_file: .env
    environment:
      VITE_AUTH_API: ${VITE_AUTH_API}
      VITE_FORMS_API: ${VITE_FORMS_API}
      VITE_RESPONSES_API: ${VITE_RESPONSES_API}
      VITE_RESPONSES_SUBMIT_PATH: ${VITE_RESPONSES_SUBMIT_PATH:-/submit}
    ports: ["5173:80"]
    depends_on:
      - auth-service
      - forms-service
      - responses-service
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro

volumes:
  auth_data:
  forms_data:
  resp_data:
